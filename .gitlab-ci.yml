notify-mattermost:
  image: ubuntu:latest
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  script: |
    apt-get update && apt-get install -y curl jq

    # ë³€ê²½ëœ íŒŒì¼ ê²½ë¡œ í™•ì¸
    CHANGED_FILES=$(curl --header "PRIVATE-TOKEN: $GITLAB_ACCESS_TOKEN" "$CI_API_V4_URL/projects/$CI_PROJECT_ID/merge_requests/$CI_MERGE_REQUEST_IID/changes" | jq -r '.changes[].new_path')
    
    # BE íŒŒì¼ ë³€ê²½ ì—¬ë¶€
    BE_CHANGES=$(echo "$CHANGED_FILES" | grep "^BE/")
    # FE íŒŒì¼ ë³€ê²½ ì—¬ë¶€
    FE_CHANGES=$(echo "$CHANGED_FILES" | grep "^FE/")

    # MR ìƒíƒœì— ë”°ë¥¸ ë©”ì‹œì§€ ì„¤ì •
    case "$CI_MERGE_REQUEST_EVENT_TYPE" in
      "open")
        STATUS=":manggom_1: **ìƒˆë¡œìš´ MRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!** :manggom_1: "
        COLOR="#36a64f"
        ;;
      "reopen")
        STATUS=":duck_dance: **MRì´ ë‹¤ì‹œ ì—´ë ¸ìŠµë‹ˆë‹¤!** :duck_dance: "
        COLOR="#ffcc00"
        ;;
      "merge")
        STATUS=":kirby_shake: **MRì´ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!** :kirby_shake: "
        COLOR="#0000ff"
        ;;
      "close")
        STATUS=":sad-shin-chang: **MRì´ ë‹«í˜”ìŠµë‹ˆë‹¤.** :sad-shin-chang: "
        COLOR="#ff0000"
        ;;
    esac

    # JSON í˜ì´ë¡œë“œ ìƒì„±
    PAYLOAD='{
      "attachments": [{
        "color": "'"$COLOR"'",
        "title": "'"$STATUS"'",
        "text": "ğŸ“Œ *ì œëª©:* **'"$CI_MERGE_REQUEST_TITLE"'** \n\nğŸ‘¤ *ì‘ì„±ì:* **'"$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME"'** \n\nğŸ”— [MR ë§í¬]('"$CI_MERGE_REQUEST_PROJECT_URL/-/merge_requests/$CI_MERGE_REQUEST_IID"')",
        "footer": "ğŸ˜º Approve í•„ìˆ˜! ğŸ˜º ",
        "ts": '$(date +%s)'
      }]
    }'

    # BE ë³€ê²½ì‚¬í•­ì´ ìˆìœ¼ë©´ BE ì±„ë„ë¡œ ì•Œë¦¼
    if [ ! -z "$BE_CHANGES" ]; then
      curl -X POST -H 'Content-Type: application/json' \
        -d "$PAYLOAD" $MATTERMOST_BE_WEBHOOK_URL
    fi

    # FE ë³€ê²½ì‚¬í•­ì´ ìˆìœ¼ë©´ FE ì±„ë„ë¡œ ì•Œë¦¼
    if [ ! -z "$FE_CHANGES" ]; then
      curl -X POST -H 'Content-Type: application/json' \
        -d "$PAYLOAD" $MATTERMOST_FE_WEBHOOK_URL
    fi